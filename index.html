<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Booking Request Demo — EN/ES/FR</title>
  <meta name="description" content="Appointment request demo (EN/ES/FR). Only available times are shown. Business can confirm and send reminders." />
  <style>
    :root{
      --bg:#0b0f17;
      --card:#111827;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --line:rgba(148,163,184,.18);
      --accent:#60a5fa;
      --accent2:#34d399;
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(96,165,250,.22), transparent 60%),
        radial-gradient(1200px 800px at 100% 10%, rgba(52,211,153,.18), transparent 55%),
        var(--bg);
      color:var(--text)
    }
    .wrap{max-width:1040px;margin:0 auto;padding:28px 16px 70px}
    .card{background:rgba(17,24,39,.82);border:1px solid var(--line);border-radius:var(--r);padding:22px;box-shadow:0 14px 60px rgba(0,0,0,.35)}
    .top{display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap}
    .brand b{font-size:16px;letter-spacing:.2px}
    .pill{margin-top:6px;font-size:12px;color:#cfe7ff;opacity:.95}
    .lang{display:flex;gap:8px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border-radius:999px;border:1px solid var(--line);background:rgba(11,15,23,.35);color:var(--text);text-decoration:none;font-weight:700;cursor:pointer;user-select:none}
    .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#06101a;border-color:transparent}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    h1{margin:14px 0 10px;font-size:clamp(26px,4vw,40px);line-height:1.12}
    p{margin:0 0 14px;color:var(--muted);line-height:1.55}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:14px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .tile{border:1px solid var(--line);background:rgba(11,15,23,.35);border-radius:14px;padding:14px}
    .tile b{display:block;margin-bottom:6px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;align-items:center}
    .foot{margin-top:18px;color:var(--muted);font-size:13px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .hidden{display:none}
    form{margin-top:14px}
    .formgrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    @media(max-width:820px){.formgrid{grid-template-columns:1fr}}
    label{display:block;font-size:13px;color:var(--muted);margin:0 0 6px}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(11,15,23,.35);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:96px;resize:vertical}
    .divider{height:1px;background:var(--line);margin:16px 0}
    .status{
      margin-top:12px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(11,15,23,.35);
      color:var(--text);
      display:none;
      line-height:1.4;
      font-size:14px;
    }
    .status.ok{border-color:rgba(52,211,153,.35)}
    .status.err{border-color:rgba(248,113,113,.35)}
    .small{font-size:12px;color:var(--muted);margin-top:10px}
    .consent{
      margin-top:12px;
      border:1px solid var(--line);
      background:rgba(11,15,23,.35);
      border-radius:14px;
      padding:12px 12px;
    }
    .consentRow{display:flex;gap:10px;align-items:flex-start}
    .consent input[type="checkbox"]{width:auto;margin-top:3px}
    .consentText{font-size:12px;color:var(--muted);line-height:1.4}
    .consentText b{color:var(--text)}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      font-size:12px;color:var(--muted);
      padding:8px 10px;border:1px solid var(--line);border-radius:999px;
      background:rgba(11,15,23,.35);
    }
    .badge b{color:var(--text)}
  </style>
</head>
<body>
  <main class="wrap">
    <div class="card">
      <div class="top">
        <div class="brand">
          <b id="bizNameTop">Smart Booking Assistant (Demo)</b>
          <div class="pill" id="bizPill">Availability • Requests • Confirmation • Reminders</div>
        </div>

        <div class="lang">
          <button class="btn" type="button" onclick="setLang('en')">EN</button>
          <button class="btn" type="button" onclick="setLang('es')">ES</button>
          <button class="btn" type="button" onclick="setLang('fr')">FR</button>
        </div>
      </div>

      <!-- EN -->
      <section id="en">
        <h1>Book only available times</h1>
        <p>
          Select a date to see available time slots. Closed or full days show automatically.
          SMS/email are used only for confirmations and reminders — no spam.
        </p>

        <div class="row">
          <span class="badge">Time zone: <b>America/Montreal</b></span>
          <span class="badge">Request ID: <b id="reqIdEn"></b></span>
        </div>

        <form id="requestFormEn" onsubmit="return submitRequest(event, 'en')">
          <div class="formgrid">
            <div>
              <label for="nameEn">Full name *</label>
              <input id="nameEn" name="name" placeholder="Your name" required />
            </div>
            <div>
              <label for="phoneEn">Phone *</label>
              <input id="phoneEn" name="phone" inputmode="tel" pattern="^[0-9+()\\-\\s]{7,20}$" placeholder="e.g. 5141234567" required />
            </div>

            <div>
              <label for="emailEn">Email *</label>
              <input id="emailEn" name="email" type="email" placeholder="you@gmail.com" required />
            </div>
            <div>
              <label for="serviceEn">Service (optional)</label>
              <select id="serviceEn" name="service">
                <option value="">Select (optional)</option>
                <option>Haircut</option>
                <option>Beard</option>
                <option>Facial</option>
                <option>Nails</option>
                <option>Lashes</option>
                <option>Consultation</option>
                <option>Other</option>
              </select>
            </div>

            <div>
              <label for="dateEn">Preferred date *</label>
              <input id="dateEn" name="date" type="date" required />
            </div>
            <div>
              <label for="timeEn">Available time *</label>
              <select id="timeEn" name="time" required></select>
            </div>
          </div>

          <div style="margin-top:12px;">
            <label for="noteEn">Notes (optional)</label>
            <textarea id="noteEn" name="note" placeholder="e.g. special requests, preferred staff..."></textarea>
          </div>

          <div class="consent">
            <div class="consentRow">
              <input id="smsOkEn" name="sms_consent" type="checkbox" required />
              <div class="consentText">
                <b>I agree to receive SMS</b> for <b>appointment confirmation and reminders only</b>. No marketing messages.
              </div>
            </div>
          </div>

          <div class="row">
            <button class="btn primary" id="sendBtnEn" type="submit">Send request</button>
            <button class="btn" type="button" onclick="fillExample('en')">Fill example</button>
          </div>

          <div class="small">Slots are based on 45 minutes + 15 minutes buffer (1-hour slots).</div>
          <div class="status" id="statusEn"></div>
        </form>

        <div class="divider"></div>

        <div class="grid">
          <div class="tile"><b>No overlaps</b><span>Only valid time slots appear.</span></div>
          <div class="tile"><b>Fewer no-shows</b><span>Reminders by SMS/email (if enabled).</span></div>
          <div class="tile"><b>Everything logged</b><span>Requests are saved for follow-up.</span></div>
        </div>
      </section>

      <!-- ES -->
      <section id="es" class="hidden">
        <h1>Reserva solo horas disponibles</h1>
        <p>
          Elige una fecha para ver horarios disponibles. Si el día está cerrado o completo, aparecerá automáticamente.
          SMS/correo solo para confirmación y recordatorios — sin spam.
        </p>

        <div class="row">
          <span class="badge">Zona horaria: <b>America/Montreal</b></span>
          <span class="badge">ID de solicitud: <b id="reqIdEs"></b></span>
        </div>

        <form id="requestFormEs" onsubmit="return submitRequest(event, 'es')">
          <div class="formgrid">
            <div>
              <label for="nameEs">Nombre completo *</label>
              <input id="nameEs" name="name" placeholder="Tu nombre" required />
            </div>
            <div>
              <label for="phoneEs">Teléfono *</label>
              <input id="phoneEs" name="phone" inputmode="tel" pattern="^[0-9+()\\-\\s]{7,20}$" placeholder="Ej: 5141234567" required />
            </div>

            <div>
              <label for="emailEs">Email *</label>
              <input id="emailEs" name="email" type="email" placeholder="tunombre@gmail.com" required />
            </div>
            <div>
              <label for="serviceEs">Servicio (opcional)</label>
              <select id="serviceEs" name="service">
                <option value="">Selecciona (opcional)</option>
                <option>Corte</option>
                <option>Barba</option>
                <option>Facial</option>
                <option>Uñas</option>
                <option>Pestañas</option>
                <option>Consulta</option>
                <option>Otro</option>
              </select>
            </div>

            <div>
              <label for="dateEs">Fecha preferida *</label>
              <input id="dateEs" name="date" type="date" required />
            </div>
            <div>
              <label for="timeEs">Hora disponible *</label>
              <select id="timeEs" name="time" required></select>
            </div>
          </div>

          <div style="margin-top:12px;">
            <label for="noteEs">Nota (opcional)</label>
            <textarea id="noteEs" name="note" placeholder="Ej: preferencia de persona, varios servicios, etc."></textarea>
          </div>

          <div class="consent">
            <div class="consentRow">
              <input id="smsOkEs" name="sms_consent" type="checkbox" required />
              <div class="consentText">
                <b>Acepto recibir SMS</b> solo para <b>confirmación y recordatorios</b>. No enviamos marketing.
              </div>
            </div>
          </div>

          <div class="row">
            <button class="btn primary" id="sendBtnEs" type="submit">Enviar solicitud</button>
            <button class="btn" type="button" onclick="fillExample('es')">Llenar ejemplo</button>
          </div>

          <div class="small">Horarios basados en 45 min + 15 min de buffer (slots de 1 hora).</div>
          <div class="status" id="statusEs"></div>
        </form>

        <div class="divider"></div>

        <div class="grid">
          <div class="tile"><b>Sin choques</b><span>Solo aparecen horarios válidos.</span></div>
          <div class="tile"><b>Menos “no-shows”</b><span>Recordatorios por SMS/email (si se activan).</span></div>
          <div class="tile"><b>Todo registrado</b><span>La solicitud se guarda para seguimiento.</span></div>
        </div>
      </section>

      <!-- FR -->
      <section id="fr" class="hidden">
        <h1>Choisissez seulement des heures disponibles</h1>
        <p>
          Choisissez une date pour voir les créneaux disponibles. Si le jour est fermé ou complet, cela s’affiche automatiquement.
          SMS/email uniquement pour confirmation et rappels — pas de spam.
        </p>

        <div class="row">
          <span class="badge">Fuseau horaire: <b>America/Montreal</b></span>
          <span class="badge">ID demande: <b id="reqIdFr"></b></span>
        </div>

        <form id="requestFormFr" onsubmit="return submitRequest(event, 'fr')">
          <div class="formgrid">
            <div>
              <label for="nameFr">Nom complet *</label>
              <input id="nameFr" name="name" placeholder="Votre nom" required />
            </div>
            <div>
              <label for="phoneFr">Téléphone *</label>
              <input id="phoneFr" name="phone" inputmode="tel" pattern="^[0-9+()\\-\\s]{7,20}$" placeholder="ex: 5141234567" required />
            </div>

            <div>
              <label for="emailFr">Email *</label>
              <input id="emailFr" name="email" type="email" placeholder="vous@gmail.com" required />
            </div>
            <div>
              <label for="serviceFr">Service (optionnel)</label>
              <select id="serviceFr" name="service">
                <option value="">Choisir (optionnel)</option>
                <option>Coupe</option>
                <option>Barbe</option>
                <option>Soin visage</option>
                <option>Ongles</option>
                <option>Cils</option>
                <option>Consultation</option>
                <option>Autre</option>
              </select>
            </div>

            <div>
              <label for="dateFr">Date préférée *</label>
              <input id="dateFr" name="date" type="date" required />
            </div>
            <div>
              <label for="timeFr">Heure disponible *</label>
              <select id="timeFr" name="time" required></select>
            </div>
          </div>

          <div style="margin-top:12px;">
            <label for="noteFr">Note (optionnel)</label>
            <textarea id="noteFr" name="note" placeholder="ex: demandes spéciales, personnel préféré..."></textarea>
          </div>

          <div class="consent">
            <div class="consentRow">
              <input id="smsOkFr" name="sms_consent" type="checkbox" required />
              <div class="consentText">
                <b>J’accepte de recevoir des SMS</b> uniquement pour <b>confirmation et rappels</b>. Pas de marketing.
              </div>
            </div>
          </div>

          <div class="row">
            <button class="btn primary" id="sendBtnFr" type="submit">Envoyer la demande</button>
            <button class="btn" type="button" onclick="fillExample('fr')">Remplir exemple</button>
          </div>

          <div class="small">Créneaux basés sur 45 min + 15 min de buffer (1 heure).</div>
          <div class="status" id="statusFr"></div>
        </form>

        <div class="divider"></div>

        <div class="grid">
          <div class="tile"><b>Sans chevauchement</b><span>Seulement des créneaux valides.</span></div>
          <div class="tile"><b>Moins d’absences</b><span>Rappels SMS/email (si activés).</span></div>
          <div class="tile"><b>Historique</b><span>La demande est enregistrée pour suivi.</span></div>
        </div>
      </section>

      <div class="foot">
        <div>© <span id="year"></span> Smart Booking Assistant (Demo)</div>
        <div><a href="mailto:demo@bookingautomation.ca">demo@bookingautomation.ca</a></div>
      </div>
    </div>
  </main>

  <script>
    // ===== CONFIG =====
    const MAKE_WEBHOOK_URL = "https://hook.us2.make.com/jsqq2dn8jrw7kaiejplcjiro7t2cloot";
    const TIME_ZONE = "America/Montreal";
    const DEFAULT_LANG = "en";

    // 45 min service + 15 min buffer = 60 min slots
    const SLOT_MINUTES = 60;

    // Business hours
    // 0=Sun ... 6=Sat
    const HOURS = {
      1: { start: "09:00", end: "19:00" }, // Mon
      2: { start: "09:00", end: "19:00" }, // Tue
      3: { start: "09:00", end: "19:00" }, // Wed
      4: { start: "09:00", end: "19:00" }, // Thu
      5: { start: "09:00", end: "19:00" }, // Fri
      6: { start: "10:00", end: "17:00" }, // Sat
      0: null                               // Sun closed
    };

    // ===== UI Setup =====
    document.getElementById("year").textContent = new Date().getFullYear();

    function setLang(l){
      document.getElementById("en").classList.toggle("hidden", l !== "en");
      document.getElementById("es").classList.toggle("hidden", l !== "es");
      document.getElementById("fr").classList.toggle("hidden", l !== "fr");
      localStorage.setItem("lang", l);
      document.documentElement.lang = l;

      // refresh request id and time dropdown in the active language
      refreshRequestId();
      const f = getForm(l);
      const dateEl = f.querySelector('[name="date"]');
      const timeEl = f.querySelector('[name="time"]');
      if(dateEl && timeEl){
        fillTimeSelect(timeEl, dateEl.value, l);
      }
    }

    function getForm(lang){
      if(lang === "en") return document.getElementById("requestFormEn");
      if(lang === "es") return document.getElementById("requestFormEs");
      return document.getElementById("requestFormFr");
    }
    function getStatus(lang){
      if(lang === "en") return document.getElementById("statusEn");
      if(lang === "es") return document.getElementById("statusEs");
      return document.getElementById("statusFr");
    }
    function getSendBtn(lang){
      if(lang === "en") return document.getElementById("sendBtnEn");
      if(lang === "es") return document.getElementById("sendBtnEs");
      return document.getElementById("sendBtnFr");
    }
    function reqSpan(lang){
      if(lang === "en") return document.getElementById("reqIdEn");
      if(lang === "es") return document.getElementById("reqIdEs");
      return document.getElementById("reqIdFr");
    }

    // ===== Request IDs =====
    function newRequestId(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      const rand = Math.random().toString(16).slice(2,10);
      return `req_${y}${m}${day}_${rand}`;
    }
    let currentRequestId = newRequestId();
    function refreshRequestId(){
      ["en","es","fr"].forEach(l => reqSpan(l).textContent = currentRequestId);
    }
    refreshRequestId();

    // ===== Slots =====
    function toMinutes(hhmm){
      const [h,m] = hhmm.split(":").map(Number);
      return h*60 + m;
    }
    function toHHMM(min){
      const h = Math.floor(min/60);
      const m = min%60;
      return String(h).padStart(2,"0")+":"+String(m).padStart(2,"0");
    }
    function buildSlotsForDate(dateStr){
      if(!dateStr) return [];
      const d = new Date(dateStr + "T12:00:00"); // safe noon
      const dow = d.getDay();
      const hours = HOURS[dow];
      if(!hours) return [];

      const start = toMinutes(hours.start);
      const end = toMinutes(hours.end);

      const slots = [];
      for(let t=start; t + SLOT_MINUTES <= end; t += SLOT_MINUTES){
        slots.push(toHHMM(t));
      }
      return slots;
    }

    function fillTimeSelect(selectEl, dateStr, lang){
      const slots = buildSlotsForDate(dateStr);

      selectEl.innerHTML = "";
      const ph = document.createElement("option");
      ph.value = "";
      ph.textContent =
        (lang==="es") ? "Selecciona una hora" :
        (lang==="fr") ? "Choisir une heure" :
        "Select a time";
      ph.disabled = true;
      ph.selected = true;
      selectEl.appendChild(ph);

      if(slots.length === 0){
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent =
          (lang==="es") ? "No hay disponibilidad ese día" :
          (lang==="fr") ? "Aucune disponibilité ce jour-là" :
          "No availability for this date";
        opt.disabled = true;
        selectEl.appendChild(opt);
        selectEl.disabled = true;
        return;
      }

      selectEl.disabled = false;
      for(const s of slots){
        const opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        selectEl.appendChild(opt);
      }

      // ✅ IMPORTANT: auto-select first real slot so form is valid
      if(selectEl.options.length > 1){
        selectEl.selectedIndex = 1;
      }
    }

    // Update slots on date change for all languages
    ["en","es","fr"].forEach(lang => {
      const f = getForm(lang);
      const dateEl = f.querySelector('[name="date"]');
      const timeEl = f.querySelector('[name="time"]');
      if(dateEl && timeEl){
        dateEl.addEventListener("change", () => {
          fillTimeSelect(timeEl, dateEl.value, lang);
        });
      }
    });

    // ===== Fill example =====
    function fillExample(lang){
      const f = getForm(lang);
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth()+1).padStart(2,'0');
      const dd = String(today.getDate()+1).padStart(2,'0');

      f.querySelector('[name="name"]').value = (lang==="fr") ? "Jean Dupont" : (lang==="es" ? "Juan Pérez" : "John Smith");
      f.querySelector('[name="phone"]').value = "5141234567";
      f.querySelector('[name="email"]').value = "client@example.com";
      f.querySelector('[name="service"]').value = (lang==="fr") ? "Coupe" : (lang==="es" ? "Corte" : "Haircut");
      f.querySelector('[name="date"]').value = `${yyyy}-${mm}-${dd}`;

      const timeEl = f.querySelector('[name="time"]');
      fillTimeSelect(timeEl, `${yyyy}-${mm}-${dd}`, lang);

      f.querySelector('[name="note"]').value =
        (lang==="fr") ? "Première visite. Merci de confirmer la disponibilité."
        : (lang==="es") ? "Primera vez. Por favor confirma disponibilidad."
        : "First time. Please confirm availability.";
      f.querySelector('[name="sms_consent"]').checked = true;
    }

    // ===== Submit =====
    async function submitRequest(event, lang){
      event.preventDefault();

      const form = getForm(lang);
      const status = getStatus(lang);
      const btn = getSendBtn(lang);

      const dateVal = form.querySelector('[name="date"]').value;
      const timeEl = form.querySelector('[name="time"]');

      // If time select not yet filled, fill it
      if(timeEl && timeEl.options.length <= 1){
        fillTimeSelect(timeEl, dateVal, lang);
      }

      const data = {
        request_id: currentRequestId,
        lang: lang,
        time_zone: TIME_ZONE,

        name: form.querySelector('[name="name"]').value.trim(),
        phone: form.querySelector('[name="phone"]').value.trim(),
        email: form.querySelector('[name="email"]').value.trim(),
        service: form.querySelector('[name="service"]').value || "",
        date: dateVal,
        time: (timeEl && !timeEl.disabled) ? timeEl.value : "",
        note: form.querySelector('[name="note"]').value.trim(),
        sms_consent: !!form.querySelector('[name="sms_consent"]').checked,

        status: "pending",
        source: "website",
        submitted_at_iso: new Date().toISOString()
      };

      // No availability (closed/full)
      if(!data.date || (timeEl && timeEl.disabled)){
        status.className = "status err";
        status.style.display = "block";
        status.textContent =
          (lang==="es") ? "No hay disponibilidad para esta fecha. Elige otra fecha." :
          (lang==="fr") ? "Aucune disponibilité pour cette date. Choisissez une autre date." :
          "No availability for this date. Please choose another date.";
        return false;
      }

      // Required validation (includes time + consent)
      if(!data.name || !data.phone || !data.email || !data.time || !data.sms_consent){
        status.className = "status err";
        status.style.display = "block";
        status.textContent =
          (lang==="es") ? "Completa los campos obligatorios y acepta el consentimiento SMS." :
          (lang==="fr") ? "Veuillez remplir les champs obligatoires et accepter le consentement SMS." :
          "Please complete required fields and accept SMS consent.";
        return false;
      }

      btn.disabled = true;
      status.className = "status";
      status.style.display = "block";
      status.textContent =
        (lang==="es") ? "Enviando solicitud..." :
        (lang==="fr") ? "Envoi en cours..." :
        "Sending request...";

      try{
        const res = await fetch(MAKE_WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
        if(!res.ok) throw new Error("HTTP " + res.status);

        status.className = "status ok";
        status.textContent =
          (lang==="es") ? "¡Solicitud enviada! Te confirmaremos por SMS/correo." :
          (lang==="fr") ? "Demande envoyée ! Nous confirmerons par SMS/email." :
          "Request sent! We will confirm by SMS/email.";

        form.reset();

        // New request id for next submission
        currentRequestId = newRequestId();
        refreshRequestId();

        // Clear time dropdown after reset
        const timeEl2 = form.querySelector('[name="time"]');
        if(timeEl2){
          timeEl2.innerHTML = "";
          timeEl2.disabled = false;
        }

      }catch(err){
        status.className = "status err";
        status.textContent =
          (lang==="es") ? "Error al enviar la solicitud. Intenta de nuevo." :
          (lang==="fr") ? "Erreur lors de l’envoi. Réessayez." :
          "Error sending request. Please try again.";
        console.error(err);
      }finally{
        btn.disabled = false;
      }
      return false;
    }

    // Init language
    setLang(localStorage.getItem("lang") || DEFAULT_LANG);
  </script>
</body>
</html>
